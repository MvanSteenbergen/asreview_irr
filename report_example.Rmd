---
title: "ASReview report"
output:
  # word_document:
  #   toc: yes
  #   toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: true
    theme: united
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
# Load packages.
library(readr)
library(dplyr)
library(stringr)
library(purrr)
library(irr)
library(kableExtra)
```

```{r start}
# Load data.
first_df <- read_csv("data/asreview_result_spatial-and-temporal-patterning-of-emergency-reactive-police-demand.csv")
secon_df <- read_csv("data/asreview_result_spatial-and-temporal-patterning-of-emergency-reactive-police-demand-2nd-coder.csv")

# Total reviewed.
first_total <- table(first_df$included)[[2]] + table(first_df$included)[[1]]
secon_total <- table(secon_df$included)[[2]] + table(secon_df$included)[[1]]

# Relevant flags.
first_rele <- table(first_df$included)[[2]]
first_irre <- table(first_df$included)[[1]]

# Irrelevant flags.
secon_rele <- table(secon_df$included)[[2]]
secon_irre <- table(secon_df$included)[[1]]

# Not reviewed
first_unrev <- sum(is.na(first_df$included))
secon_unrev <- sum(is.na(secon_df$included))

# % reviewed.
first_prev <- round(100*first_total/nrow(first_df), 2)
secon_prev <- round(100*secon_total/nrow(secon_df), 2)

# Total irrelevant.
first_trele <- first_irre + first_unrev
secon_trele <- secon_irre + secon_unrev

# % total relevant.
first_ptrel <- round(100*first_rele/nrow(first_df), 2)
secon_ptrel <- round(100*secon_rele/nrow(secon_df), 2)

# % flagged relevant.
first_pfrel <- round(100*first_rele/first_total, 2)
secon_pfrel <- round(100*secon_rele/secon_total, 2)

# Recode 'not rated' as irrelevant in each data frame.
first_rec_df <- first_df %>%
  mutate(included_rec = if_else(is.na(included), true = 0, false = included))

secon_rec_df <- secon_df %>%
  mutate(included_rec = if_else(is.na(included), true = 0, false = included))


# Disagreements 1: Second coder says relevant, first coder says irrelevant
first_irrelevant_vec <- first_rec_df %>% 
  filter(included == 0) %>% 
  pluck("record_id")

# Choose the relevant select() option for your data.
disagree1_df <- secon_rec_df %>% 
  filter(included == 1, record_id %in% first_irrelevant_vec) %>% 
  # select(record_id, authors, year, title, abstract) # For newer projects.
  select(record_id, first_authors, publication_year, primary_title, notes_abstract) # For older projects.

first_dis <- nrow(disagree1_df) # 5

# # Temp test.
# first_relevant_vec <- first_rec_df %>% 
#   filter(included == 1) %>% 
#   pluck("record_id")
# 
# disagree1a_df <- secon_rec_df %>% 
#   filter(included == 0, record_id %in% first_relevant_vec) %>% 
#   # select(record_id, authors, year, title, abstract) # For newer projects.
#   select(record_id, first_authors, publication_year, primary_title, notes_abstract) # For older projects.

# Disagreement 2: First coder says relevant, second coder says irrelevant, 
secon_irrelevant_vec <- secon_rec_df %>% 
  filter(included == 0) %>% 
  pluck("record_id")

# Choose the relevant select() option for your data.
disagree2_df <- first_rec_df %>% 
  filter(included == 1, record_id %in% secon_irrelevant_vec) %>% 
  # select(record_id, authors, year, title, abstract) # For newer projects.
  select(record_id, first_authors, publication_year, primary_title, notes_abstract) # For older projects.

secon_dis <- nrow(disagree2_df) # 39

# Sort and create vectors for Kappa.
first_vec <- first_rec_df %>% 
  arrange(record_id) %>% 
  pluck("included")

secon_vec <- secon_rec_df %>% 
  arrange(record_id) %>% 
  pluck("included")

# Create array for Kappa.
full_array <- cbind(first_vec, secon_vec)

# Further disgareement statistics.

# Identify those which each reviewer did not even look at.
first_dist_vec <- first_rec_df %>% 
  # filter(included == 3) %>% 5 Dec 2023 change.
  filter(is.na(included)) %>%
  pluck("record_id")

secon_dist_vec <- secon_rec_df %>% 
  # filter(included == 3) %>% 5 Dec 2023 change.
  filter(is.na(included)) %>%
  pluck("record_id")

# Identify those relevant by one rather, and unreviewed by the other.
first_dist_df <- first_rec_df %>% 
  filter(included == 1) %>% 
  mutate(missed = if_else(record_id %in% secon_dist_vec,
                          "missed",
                          "not missed"))

secon_dist_df <- secon_rec_df %>% 
  filter(included == 1) %>% 
  mutate(missed = if_else(record_id %in% first_dist_vec,
                          "missed",
                          "not missed"))

# How many studies did one rather say *relevcant* and the other reviewer
# not even review?
missed1 <- nrow(first_dist_df) - table(first_dist_df$missed)[["not missed"]]
missed2 <- nrow(secon_dist_df) - table(secon_dist_df$missed)[["not missed"]]
```

# Rater summary

|                          | rater A            | rater B            |
| ------------------------ |:------------------:| ------------------:|
| n uploaded               | `r nrow(first_df)` | `r nrow(secon_df)` |
| n reviewed               | `r first_total`    | `r secon_total`    |
| % reviewed               | `r first_prev`     | `r secon_prev`     |
| n flagged relevant       | `r first_rele`     | `r secon_rele`     |
| n flagged irrelevant     | `r first_irre`     | `r secon_irre`     |
| % flagged relevant       | `r first_pfrel`    | `r secon_pfrel`    |
| n unreviewed             | `r first_unrev`    | `r secon_unrev`    |
| n total irrelevant       | `r first_trele`    | `r secon_trele`    |
| % total relevant         | `r first_ptrel`    | `r secon_ptrel`    |
| n relevant v. irrelevant | `r secon_dis`      | `r first_dis`      | 
| n relevant v. unreviewed | `r missed1`        | `r missed2`        | 

# Overall summary

```{r additionaltable}
# Remove the notes col
secon_df <- secon_df %>% 
  # select(-exported_notes_1) %>%      # add if needed.
  mutate(rater_id = 2) 
  # rename(record_id = `Ã¯..record_id`) # add if needed.

# Create rater id for the first rater.
first_df <- first_df %>% 
  mutate(rater_id = 1)

# Bind together.
first_secon_review_df <- bind_rows(first_df, secon_df) %>% 
  mutate(included_new = if_else(is.na(included), 1000, included))

# Create summary table.
compare_df <- first_secon_review_df %>% 
  # group_by(record_id, title) %>%       # add if needed. 
  group_by(record_id, first_authors, publication_year, primary_title, notes_abstract) %>% # comment out if needed.
  summarise(agreement_number = sum(included_new)) %>% 
  ungroup()

# Check counts.


# Summary table.
table2_summary_df <- count(compare_df, agreement_number) %>%
  mutate(stat = ifelse(agreement_number == 0   , "Both rated irrelevant"                      , NA),
         stat = ifelse(agreement_number == 1   , "One rated relevant, other irrelevant"       , stat),
         stat = ifelse(agreement_number == 2   , "Both rated relevant"                        , stat),
         stat = ifelse(agreement_number == 1000, "One rated irrelevant, other left unreviewed", stat),
         stat = ifelse(agreement_number == 1001, "One rated relevant, other left unreviewed"  , stat),
         stat = ifelse(agreement_number == 2000, "Both left unreviewed"                       , stat)) %>% 
  select(stat, n) %>% 
  rename(Description = stat)

kable(table2_summary_df)

```

# Written explanations 

- Reviewer A evaluated `r first_total` of `r nrow(first_df)` articles (`r first_prev`%), of which (s)he flagged `r first_rele` as relevant and `r first_irre` as irrelevant.
- Reviewer B evaluated `r secon_total` of `r nrow(secon_df)` articles (`r secon_prev`%), of which (s)he flagged `r secon_rele` as relevant and `r secon_irre` as irrelevant.
- Rater A left a total of `r first_unrev` articles unreviewed, while rater B left `r secon_unrev` unreviewed. In other words, these articles lay beyond the 'stop rule' and were never seen by the raters.
- Rater B flagged `r missed2` article(s) as relevant that rater B never reviewed because it lay beyond the stop rule. This figure for Rater A was `r missed1`. 
- The 'total irrelevant' figure is the sum of (1) the number of articles actively flagged as irrelevant by raters and (2) the number of articles left unreviewed after the stop rule (and therefore assumed to be irrelevant).
- Rater A flagged `r secon_dis` articles as relevant that rater B flagged as irrelevant. Conversely, rater B flagged `r first_dis` articles as relevant that rater B flagged as irrelevant.

```{r irrdatasave}
irr_df <- tibble(
  ` ` = c("n uploaded", 
                "n reviewed",
                "% reviewed",
                "n flagged relevant",
                "n flagged irrelevant",
                "% flagged relevant",
                "n unreviewed",
                "n total irrelevant",
                "% total relevant",
                "n relevant v. irrelevant",
                "n relevant v. unreviewed"),
  `rater A` = c(nrow(first_df),
                first_total,
                first_prev,
                first_rele,
                first_irre,
                first_pfrel,
                first_unrev,
                first_trele,
                first_ptrel,
                first_dis,
                missed1),
  `rater B` = c(nrow(secon_df),
                secon_total,
                secon_prev,
                secon_rele,
                secon_irre,
                secon_pfrel,
                secon_unrev,
                secon_trele,
                secon_ptrel,
                secon_dis,
                missed2)
  )

write_csv(x = irr_df, file = "data/irr_table.csv")

```

# Kappa

The level of agreement between rater A and rater B is the following:

```{r}
agree(full_array)
```

The Kappa statistic is the following:

```{r}
kappa2(full_array)
```

# Disagreements

## Relevant versus unreviewed

If there are any, the following are the articles for which one rater flagged 'relevant' and the other did not review it because it lay beyond the stop rule.

```{r}
if (missed1 == 0 & missed2 == 0) {
  print("There were no articles for which one rater flagged 'relevant' and the other did not review it.")
} else {
  compare_df %>% 
    filter(agreement_number == 1001) %>%
    select(-agreement_number) %>% 
    kable(col.names = c("id", "author(s)", "year", "title", "abstract")) %>%
  kable_styling()
  
}
```

## Rater A

Studies for which  rater A flagged relevant and rater B flagged irrelevant.

```{r}
# Here, note that ASReview updated their default column names late-2021. 
# If your project is newer (late-2021 onward) then comment out the mutate() line.

disagree2_df %>% 
  # mutate(publication_year = str_remove_all(publication_year, "///")) %>% # Only needed for older projects.
  kable(col.names = c("id", "author(s)", "year", "title", "abstract")) %>%
  # scroll_box(width = "120%", height = "300px") %>% 
  kable_styling()
```

<br>

<br>

## Rater B

Studies for which  rater B flagged relevant and rater A flagged irrelevant.

```{r}
# Here, note that ASReview updated their default column names late-2021. 
# If your project is newer (late-2021 onward) then comment out the mutate() line.

disagree1_df %>% 
  # mutate(publication_year = str_remove_all(publication_year, "///")) %>% # Only needed for older projects.
  kable(col.names = c("id", "author(s)", "year", "title", "abstract")) %>% 
  # scroll_box(width = "120%", height = "300px") %>% 
  kable_styling()
```

